
- name: Install Git and clone repository
  hosts: all
  become: yes

  vars:
    repo_url: "https://github.com/ggarrett89/python-app.git"
    repo_dest: "/opt/homelab"
    repo_version: "main"  # branch, tag, or commit hash

  tasks:
    # Step 1: Install Git
    - name: Install Git
      apt:
        name: git
        state: present
        update_cache: yes
      ignore_errors: true

    - name: Create directory for repository
      file:
        path: "{{ repo_dest }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: 0755

    # Step 2: Clone repository
    - name: Clone Git repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_dest }}"
        version: "{{ repo_version }}"
        clone: yes
        update: yes
      become: false  # Run as regular user if needed
      # become_user: devops

    # Step 3: Set repository permissions (optional)
    - name: Set repository ownership
      file:
        path: "{{ repo_dest }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        recurse: yes

    # Step 4: List repository contents
    - name: List cloned repository folders and files
      shell: ls -lah {{ repo_dest }}
      register: repo_contents

    # Step 5: Display repository contents
    - name: Show repository contents
      debug:
        var: repo_contents.stdout_lines
